<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Rescisão CLT — (GitHub Pages)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- pdf.js via CDN (funciona no GitHub Pages) -->
  <script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    // Define o worker do pdf.js (CDN)
    document.addEventListener('DOMContentLoaded', () => {
      if (window['pdfjsLib']) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
      }
    });
  </script>

  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#22d3ee;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --card:#0b1223; --line:#1f2937; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,Helvetica,sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #1e293b 0%, #0b1223 50%, var(--bg) 100%);
      color:var(--text);}
    .wrap{max-width:1220px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border:1px solid var(--line);border-radius:16px;background:rgba(17,24,39,.6);backdrop-filter: blur(6px);}
    header h1{font-size:clamp(18px,2.5vw,22px);margin:0;font-weight:700;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0a1021;color:#cbd5e1;cursor:pointer}
    .tab.active{outline:2px solid #22d3ee66}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:10px 0 16px}
    .kpi{background:linear-gradient(180deg, #0d162b, #0a1021);border:1px solid var(--line);border-radius:16px;padding:14px 16px}
    .kpi h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:600}
    .kpi .val{font-size:22px;font-weight:800;letter-spacing:.2px}
    .kpi.ok .val{color:var(--ok)} .kpi.bad .val{color:var(--bad)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{grid-column:span 12;background:linear-gradient(180deg,#0d162b,#0a1021);border:1px solid var(--line);border-radius:16px;padding:16px}
    .card h2{margin:0 0 12px 0;font-size:16px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#0b1020;color:#fff;font-size:14px;outline:none;}
    input:focus,select:focus,textarea:focus{border-color:#334155;box-shadow:0 0 0 4px rgba(34,211,238,.08)}
    .row > div{grid-column:span 12}
    @media(min-width:680px){ .row > .col-6{grid-column:span 6} .row > .col-4{grid-column:span 4} .row > .col-3{grid-column:span 3} .row > .col-2{grid-column:span 2} .row > .col-8{grid-column:span 8} }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px dashed #1f2a44;text-align:left;font-size:13px}
    th{color:#a8b3cf;font-weight:600} tfoot td{font-weight:800;font-size:15px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{cursor:pointer;border:1px solid var(--line);background:#0f152a}
    .btn:hover{filter:brightness(1.1)}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#0a1021;padding:8px 10px;border-radius:999px;font-size:12px;color:#cbd5e1}
    .hint{font-size:12px;color:#9aa7c7}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0a1021;color:#cbd5e1;display:inline-block}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .cmp-ok{color:var(--ok);font-weight:700}
    .cmp-diff{color:var(--bad);font-weight:700}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.two{grid-template-columns:1fr}}
    .drop{border:2px dashed #2a3a5a;border-radius:14px;padding:14px;text-align:center;background:#0b1020;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Calculadora de Rescisão CLT — GitHub Pages</h1>
        <div class="sub">Upload de PDFs (<strong>TRCT/Termo de Quitação</strong> e <strong>contracheques</strong>) direto no navegador.</div>
      </div>
      <div class="flex">
        <span id="badgeTipo" class="badge">Tipo: <strong id="tipoLabel">Sem justa causa</strong></span>
        <span class="badge">Aviso: <strong id="avisoLabel">Indenizado</strong></span>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="calc">Cálculo</button>
      <button class="tab" data-tab="cmp">Comparação TRCT</button>
      <button class="tab" data-tab="hist">Histórico (Contracheques)</button>
    </div>

    <section class="kpis">
      <div class="kpi"><h3>Total Bruto (cálculo)</h3><div class="val" id="kpiBruto">R$ 0,00</div></div>
      <div class="kpi"><h3>Descontos (cálculo)</h3><div class="val" id="kpiDesc">R$ 0,00</div></div>
      <div class="kpi"><h3>Multa FGTS (cálculo)</h3><div class="val" id="kpiFgts">R$ 0,00</div></div>
      <div class="kpi ok" id="kpiLiquidoBox"><h3>Total a Receber (cálculo)</h3><div class="val" id="kpiLiquido">R$ 0,00</div></div>
    </section>

    <div id="tab-calc" class="grid">
      <div class="card">
        <h2>1) Dados do contrato</h2>
        <div class="row">
          <div class="col-3"><label>Salário base mensal</label><input id="salario" type="text" inputmode="decimal" placeholder="Ex.: 2763,07"></div>
          <div class="col-3"><label>Média de variáveis (HE/adicionais)</label><input id="mediaVar" type="text" inputmode="decimal" placeholder="Ex.: 0,00"></div>
          <div class="col-3"><label>Data de admissão</label><input id="admissao" type="date"></div>
          <div class="col-3"><label>Data de desligamento</label><input id="desligamento" type="date"></div>
        </div>
        <div class="row">
          <div class="col-4">
            <label>Tipo de rescisão</label>
            <select id="tipo">
              <option value="semjusta">Sem justa causa (empregador)</option>
              <option value="acordo">Acordo entre as partes (art. 484-A, CLT)</option>
              <option value="pedido">Pedido de demissão</option>
              <option value="justa">Dispensa por justa causa</option>
              <option value="prazo">Término de contrato a prazo</option>
              <option value="prazo_empregado">Prazo determinado — rescisão antecipada pelo empregado (art. 480)</option>
              <option value="indireta">Rescisão indireta</option>
            </select>
          </div>
          <div class="col-4">
            <label>Aviso prévio</label>
            <select id="avisoTipo">
              <option value="indenizado">Indenizado</option>
              <option value="trabalhado">Trabalhado</option>
              <option value="dispensado">Dispensado / Não se aplica</option>
            </select>
          </div>
          <div class="col-4">
            <label>Dias trabalhados no mês da rescisão (saldo de salário)</label>
            <input id="diasSaldo" type="number" min="0" max="31" placeholder="Ex.: 5">
          </div>
        </div>
        <div class="row">
          <div class="col-4">
            <label>Saldo FGTS para base da multa (R$)</label>
            <input id="fgtsBase" type="text" inputmode="decimal" placeholder="Ex.: 0,00">
            <div class="hint">Informe o saldo da conta FGTS para calcular a multa (40% / 20% / 0%).</div>
          </div>
          <div class="col-4"><label>Início do último período aquisitivo de férias (opcional)</label><input id="aquisitivoInicio" type="date"></div>
          <div class="col-4"><label>Férias vencidas a indenizar (dias)</label><input id="feriasVencidasDias" type="number" min="0" max="60" placeholder="0 ou 30"></div>
        </div>
        <div class="row">
          <div class="col-4">
            <label>Descontar aviso não cumprido pelo empregado?</label>
            <select id="descontoAvisoEmpregado"><option value="nao">Não</option><option value="sim">Sim (pedido de demissão)</option></select>
          </div>
          <div class="col-4">
            <label>Indenização art. 480 (R$)</label>
            <input id="art480" type="text" inputmode="decimal" placeholder="Ex.: 227,70">
            <div class="hint">Até metade dos salários a que teria direito até o fim do contrato. Informe se aplicável.</div>
          </div>
          <div class="col-4"><label>Outros descontos manuais</label><input id="outrosDesc" type="text" inputmode="decimal" placeholder="Total de descontos diversos"></div>
        </div>
      </div>

      <div class="card">
        <h2>2) Itens calculados</h2>
        <div class="row">
          <div class="col-3"><div class="pill">Tempo de casa: <span id="tempoCasa">—</span></div></div>
          <div class="col-3"><div class="pill">Aviso (dias): <span id="avisoDias">0</span></div></div>
          <div class="col-3"><div class="pill">13º avos: <span id="avos13">0/12</span></div></div>
          <div class="col-3"><div class="pill">Férias avos: <span id="avosFerias">0/12</span></div></div>
        </div>
        <table id="tabela">
          <thead><tr><th>Verba</th><th>Base</th><th>Quantidade</th><th>Valor (R$)</th></tr></thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr><td colspan="3">Total Bruto</td><td id="totBruto">R$ 0,00</td></tr>
            <tr><td colspan="3">Descontos</td><td id="totDesc">R$ 0,00</td></tr>
            <tr><td colspan="3">Multa FGTS</td><td id="totFgts">R$ 0,00</td></tr>
            <tr><td colspan="3">Total a Receber</td><td id="totLiquido">R$ 0,00</td></tr>
          </tfoot>
        </table>
        <div class="actions">
          <button class="btn" id="btnCSV">Exportar (CSV)</button>
          <button class="btn" id="btnPDF">Imprimir / Salvar PDF</button>
          <button class="btn" id="btnZerar">Zerar campos</button>
        </div>
      </div>
    </div>

    <div id="tab-cmp" class="grid" style="display:none">
      <div class="card">
        <h2>3) Comparação com TRCT da Contabilidade</h2>
        <div class="row">
          <div class="col-12">
            <div class="drop">
              <strong>Carregar TRCT/Termo de Quitação (PDF)</strong><br>
              <input id="fileTRCT" type="file" accept="application/pdf" />
            </div>
          </div>
        </div>
        <div class="two">
          <div>
            <h3 style="margin:0 0 8px 0">Valores do TRCT (extraídos do PDF ou digite manualmente)</h3>
            <div class="row">
              <div class="col-6"><label>Saldo de salário (R$)</label><input id="trct_saldo" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>Adicionais/Insalubridade/DSR (R$)</label><input id="trct_adic" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>13º proporcional (R$)</label><input id="trct_13" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>Férias proporcionais (R$)</label><input id="trct_ferias" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>1/3 férias (R$)</label><input id="trct_terco" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>Outras verbas (R$)</label><input id="trct_outras" type="text" inputmode="decimal"></div>
            </div>
            <div class="row">
              <div class="col-6"><label>Descontos: INSS total (R$)</label><input id="trct_inss" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>Descontos: IRRF total (R$)</label><input id="trct_ir" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>Descontos: Faltas + DSR faltas (R$)</label><input id="trct_faltas" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>Desconto art. 480 (R$)</label><input id="trct_480" type="text" inputmode="decimal"></div>
              <div class="col-6"><label>Contribuições/Outros descontos (R$)</label><input id="trct_outdesc" type="text" inputmode="decimal"></div>
            </div>
          </div>
          <div>
            <h3 style="margin:0 0 8px 0">Resultados</h3>
            <table>
              <thead><tr><th>Item</th><th>Contabilidade</th><th>Calculadora</th><th>Diferença</th></tr></thead>
              <tbody id="cmpBody"></tbody>
              <tfoot>
                <tr><td>Total Bruto</td><td id="cmpBrutoC">—</td><td id="cmpBrutoM">—</td><td id="cmpBrutoD">—</td></tr>
                <tr><td>Descontos</td><td id="cmpDescC">—</td><td id="cmpDescM">—</td><td id="cmpDescD">—</td></tr>
                <tr><td>Multa FGTS</td><td id="cmpFgtsC">—</td><td id="cmpFgtsM">—</td><td id="cmpFgtsD">—</td></tr>
                <tr><td><strong>Total Líquido</strong></td><td id="cmpLiqC">—</td><td id="cmpLiqM">—</td><td id="cmpLiqD">—</td></tr>
              </tfoot>
            </table>
            <div class="hint" style="margin-top:8px">Dica: após extrair, revise os números capturados e ajuste se necessário.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-hist" class="grid" style="display:none">
      <div class="card">
        <h2>4) Histórico — Contracheques (PDFs)</h2>
        <div class="row">
          <div class="col-12">
            <div class="drop">
              <strong>Carregar contracheques (vários PDFs)</strong><br>
              <input id="filePayslips" type="file" accept="application/pdf" multiple />
              <div class="hint">Serão extraídas rubricas como horas extras, adicionais, insalubridade, descontos, etc., para calcular médias.</div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <table id="histTable">
              <thead><tr><th>Arquivo</th><th>Mês</th><th>Salário Base</th><th>HE/Variáveis</th><th>Insalubridade</th><th>INSS</th><th>IRRF</th></tr></thead>
              <tbody></tbody>
              <tfoot>
                <tr><td colspan="3"><strong>Média Variáveis (HE+Adicionais)</strong></td><td id="mediaVars">R$ 0,00</td><td colspan="3"></td></tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Notas rápidas</h2>
        <div class="hint">
          • Funciona no GitHub Pages usando pdf.js via CDN; se o PDF for escaneado (imagem), peça a versão com OCR (Tesseract.js) que também roda no navegador.<br>
          • Detectores (regex) prontos para rótulos comuns — se o seu TRCT usa outros títulos, me diga para eu ajustar.
        </div>
      </div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const brl = n => (isFinite(n) ? n : 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function parseBRL(v){
  if(v===undefined||v===null) return 0;
  if(typeof v === 'number') return v;
  v = String(v).trim();
  if(!v) return 0;
  v = v.replace(/\s/g,'').replace(/\./g,'').replace(',','.');
  const n = Number(v);
  return isFinite(n) ? n : 0;
}
function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function diffYearsFloor(a,b){
  let years = b.getFullYear() - a.getFullYear();
  const bMD = (b.getMonth()+1)*100 + b.getDate();
  const aMD = (a.getMonth()+1)*100 + a.getDate();
  if(bMD < aMD) years--;
  return Math.max(0, years);
}
function countAvosBetween(start, end, thresholdDays){
  if(!start || !end || isNaN(start) || isNaN(end) || start > end) return 0;
  let count = 0;
  let cursor = new Date(start.getFullYear(), start.getMonth(), 1);
  const last = new Date(end.getFullYear(), end.getMonth(), 1);
  while(cursor <= last){
    const mStart = cursor < start ? start : cursor;
    const mEnd = endOfMonth(cursor) > end ? end : endOfMonth(cursor);
    const days = (mEnd - mStart)/(1000*60*60*24) + 1;
    if(days >= thresholdDays) count++;
    cursor = new Date(cursor.getFullYear(), cursor.getMonth()+1, 1);
  }
  return count;
}
function projectedEndDate(des, avisoDias, avisoTipo){
  if(!des) return null;
  if(avisoTipo === 'indenizado' && avisoDias>0){ return addDays(des, avisoDias); }
  return des;
}

function calc(){
  const salario = parseBRL($('#salario').value);
  const mediaVar = parseBRL($('#mediaVar').value);
  const adm = $('#admissao').value ? new Date($('#admissao').value+'T12:00:00') : null;
  const des = $('#desligamento').value ? new Date($('#desligamento').value+'T12:00:00') : null;
  const tipo = $('#tipo').value;
  const avisoTipo = $('#avisoTipo').value;
  const diasSaldo = Number($('#diasSaldo').value || 0);
  const fgtsBase = parseBRL($('#fgtsBase').value);
  const vencidasDias = Number($('#feriasVencidasDias').value || 0);
  const descontoAvisoEmp = $('#descontoAvisoEmpregado').value === 'sim';
  const art480 = parseBRL($('#art480').value);
  const outrosDesc = parseBRL($('#outrosDesc').value);

  $('#tipoLabel').textContent = $('#tipo option:checked').textContent;
  $('#avisoLabel').textContent = $('#avisoTipo option:checked').textContent;

  const base = salario + mediaVar;

  let avisoDias = 0;
  let anos = 0;
  if(adm && des){
    anos = diffYearsFloor(adm, des);
    avisoDias = Math.max(30, Math.min(90, 30 + 3 * anos));
  }
  $('#avisoDias').textContent = avisoDias || 0;

  const endProj = (des ? projectedEndDate(des, avisoDias, avisoTipo) : null);

  let avos13 = 0;
  if(adm && des){
    const start13 = new Date(Math.max(adm, new Date(des.getFullYear(), 0, 1)));
    avos13 = countAvosBetween(start13, endProj || des, 15);
  }
  if(tipo === 'justa') avos13 = 0;
  $('#avos13').textContent = avos13 + '/12';

  let inicioAquisitivo = $('#aquisitivoInicio').value ? new Date($('#aquisitivoInicio').value+'T12:00:00') : null;
  if(!inicioAquisitivo && adm && des){
    inicioAquisitivo = new Date(des.getFullYear(), adm.getMonth(), adm.getDate());
    if(inicioAquisitivo > (endProj || des)){ inicioAquisitivo.setFullYear(inicioAquisitivo.getFullYear()-1); }
  }
  let avosFerias = 0;
  if(inicioAquisitivo && des){
    avosFerias = countAvosBetween(inicioAquisitivo, endProj || des, 14.01);
    avosFerias = avosFerias % 12;
  }
  if(tipo === 'justa') avosFerias = 0;
  $('#avosFerias').textContent = avosFerias + '/12';

  let saldoSalario = 0;
  if(salario && des && diasSaldo>0){
    const diasMes = new Date(des.getFullYear(), des.getMonth()+1, 0).getDate();
    saldoSalario = base * (diasSaldo / diasMes);
  }

  let avisoValor = 0;
  let descontoAviso = 0;
  if(avisoTipo !== 'dispensado' && avisoDias>0){
    if(tipo === 'acordo' && avisoTipo === 'indenizado'){
      avisoValor = base * (avisoDias/30) * 0.5;
    }else if(tipo === 'pedido' && avisoTipo === 'indenizado'){
      avisoValor = 0;
    }else if(tipo === 'prazo_empregado'){
      avisoValor = 0;
    }else if(avisoTipo === 'indenizado'){
      avisoValor = base * (avisoDias/30);
    }
  }
  if((tipo === 'pedido') && descontoAvisoEmp && avisoDias>0){
    descontoAviso = base * (avisoDias/30);
  }

  const decimoTerceiro = base * (avos13/12);
  const feriasVencidas = (base/30) * vencidasDias;
  const tercoVencidas = feriasVencidas / 3;
  const feriasProp = base * (avosFerias/12);
  const tercoProp = feriasProp / 3;

  let multaFGTS = 0;
  if(fgtsBase>0){
    if(tipo === 'semjusta' || tipo === 'indireta'){ multaFGTS = fgtsBase * 0.40; }
    else if(tipo === 'acordo'){ multaFGTS = fgtsBase * 0.20; }
    else { multaFGTS = 0; }
  }

  let descontos = descontoAviso + art480 + outrosDesc;

  const linhas = [];
  const pushItem = (nome, baseTxt, qtdTxt, valor) => { if(Math.abs(valor) < 0.005) return; linhas.push({nome, base:baseTxt, qtd:qtdTxt, valor}); };

  pushItem('Saldo de salário', brl(base), diasSaldo ? (diasSaldo+' dia(s)') : '—', saldoSalario);
  if(avisoValor>0) pushItem('Aviso prévio indenizado', brl(base), avisoDias+' dia(s)', avisoValor);
  if(decimoTerceiro>0) pushItem('13º salário proporcional', brl(base), avos13+'/12', decimoTerceiro);
  if(feriasVencidas>0) pushItem('Férias vencidas', brl(base/30), vencidasDias+' dia(s)', feriasVencidas);
  if(tercoVencidas>0) pushItem('1/3 sobre férias vencidas', '1/3', '—', tercoVencidas);
  if(feriasProp>0) pushItem('Férias proporcionais', brl(base), avosFerias+'/12', feriasProp);
  if(tercoProp>0) pushItem('1/3 sobre férias proporcionais', '1/3', '—', tercoProp);
  if(descontoAviso>0) pushItem('Desconto aviso não cumprido (empregado)', brl(base), avisoDias+' dia(s)', -descontoAviso);
  if(art480>0) pushItem('Indenização art. 480 (contrato a prazo)', '—', '—', -art480);
  if(outrosDesc>0) pushItem('Outros descontos manuais', '—', '—', -outrosDesc);

  const totalBruto = linhas.filter(l=>l.valor>0).reduce((s,l)=>s+l.valor,0);
  const totalDesc = linhas.filter(l=>l.valor<0).reduce((s,l)=>s+l.valor,0) * -1;
  const totalLiquido = totalBruto - totalDesc + multaFGTS;

  $('#tempoCasa').textContent = adm && des ? (anos + ' ano(s) completos') : '—';
  const tbody = $('#tbody'); tbody.innerHTML = '';
  for(const l of linhas){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${l.nome}</td><td>${l.base}</td><td>${l.qtd}</td><td>${brl(l.valor)}</td>`;
    tbody.appendChild(tr);
  }

  $('#totBruto').textContent = brl(totalBruto);
  $('#totDesc').textContent = brl(totalDesc);
  $('#totFgts').textContent = brl(multaFGTS);
  $('#totLiquido').textContent = brl(totalLiquido);
  $('#kpiBruto').textContent = brl(totalBruto);
  $('#kpiDesc').textContent = brl(totalDesc);
  $('#kpiFgts').textContent = brl(multaFGTS);
  $('#kpiLiquido').textContent = brl(totalLiquido);

  const box = $('#kpiLiquidoBox');
  box.classList.toggle('ok', totalLiquido >= 0);
  box.classList.toggle('bad', totalLiquido < 0);

  atualizarComparacao(totalBruto, totalDesc, multaFGTS, totalLiquido);
}

function exportCSV(){
  const rows = [['Verba','Base','Quantidade','Valor (R$)']];
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const tds = [...tr.children].map(td=>td.textContent);
    rows.push(tds);
  });
  const foot = [
    ['Total Bruto','','', document.querySelector('#totBruto').textContent],
    ['Descontos','','', document.querySelector('#totDesc').textContent],
    ['Multa FGTS','','', document.querySelector('#totFgts').textContent],
    ['Total a Receber','','', document.querySelector('#totLiquido').textContent],
  ];
  foot.forEach(r=>rows.push(r));
  const csv = rows.map(r=>r.map(x=>`"${x.replace(/"/g,'""')}"`).join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'rescisao_calculo.csv';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 400);
}

function printPDF(){ window.print(); }
function zerar(){
  ['salario','mediaVar','admissao','desligamento','diasSaldo','fgtsBase','aquisitivoInicio','feriasVencidasDias','art480','outrosDesc'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.value = '';
  });
  $('#tipo').value = 'semjusta';
  $('#avisoTipo').value = 'indenizado';
  $('#descontoAvisoEmpregado').value = 'nao';
  ['trct_saldo','trct_adic','trct_13','trct_ferias','trct_terco','trct_outras','trct_inss','trct_ir','trct_faltas','trct_480','trct_outdesc']
    .forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
  $('#histTable tbody').innerHTML='';
  $('#mediaVars').textContent = brl(0);
  calc(); comparar();
}

['salario','mediaVar','admissao','desligamento','tipo','avisoTipo','diasSaldo','fgtsBase','aquisitivoInicio','feriasVencidasDias','descontoAvisoEmpregado','art480','outrosDesc']
  .forEach(id=>{ document.getElementById(id).addEventListener('input', calc); document.getElementById(id).addEventListener('change', calc); });
document.getElementById('btnCSV').addEventListener('click', exportCSV);
document.getElementById('btnPDF').addEventListener('click', printPDF);
document.getElementById('btnZerar').addEventListener('click', zerar);

$$('.tab').forEach(b=>b.addEventListener('click', e=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));
  e.currentTarget.classList.add('active');
  const on = e.currentTarget.dataset.tab;
  $('#tab-calc').style.display = (on==='calc') ? '' : 'none';
  $('#tab-cmp').style.display = (on==='cmp') ? '' : 'none';
  $('#tab-hist').style.display = (on==='hist') ? '' : 'none';
}));

['trct_saldo','trct_adic','trct_13','trct_ferias','trct_terco','trct_outras','trct_inss','trct_ir','trct_faltas','trct_480','trct_outdesc']
  .forEach(id=>{ const el = document.getElementById(id); el.addEventListener('input', comparar); el.addEventListener('change', comparar); });

function somaC(...vals){ return vals.reduce((s,v)=>s+parseBRL($(v).value||0),0); }
function comparar(){ atualizarComparacao(); }

function atualizarComparacao(calcBruto=null, calcDesc=null, calcFgts=null, calcLiq=null){
  const cBruto = somaC('#trct_saldo','#trct_adic','#trct_13','#trct_ferias','#trct_terco','#trct_outras');
  const cDesc  = somaC('#trct_inss','#trct_ir','#trct_faltas','#trct_480','#trct_outdesc');
  const cFgts  = 0;
  const cLiq   = cBruto - cDesc + cFgts;

  if(calcBruto===null){ calcBruto = parseBRL($('#totBruto').textContent); }
  if(calcDesc===null){  calcDesc  = parseBRL($('#totDesc').textContent); }
  if(calcFgts===null){  calcFgts  = parseBRL($('#totFgts').textContent); }
  if(calcLiq===null){   calcLiq   = parseBRL($('#totLiquido').textContent); }

  const set = (id, val) => { $(id).textContent = brl(val); };
  set('#cmpBrutoC', cBruto); set('#cmpBrutoM', calcBruto); set('#cmpBrutoD', cBruto - calcBruto);
  set('#cmpDescC',  cDesc);  set('#cmpDescM',  calcDesc);  set('#cmpDescD',  cDesc - calcDesc);
  set('#cmpFgtsC',  cFgts);  set('#cmpFgtsM',  calcFgts);  set('#cmpFgtsD',  cFgts - calcFgts);
  set('#cmpLiqC',   cLiq);   set('#cmpLiqM',   calcLiq);   set('#cmpLiqD',   cLiq - calcLiq);

  [['#cmpBrutoD', cBruto - calcBruto], ['#cmpDescD', cDesc - calcDesc], ['#cmpFgtsD', cFgts - calcFgts], ['#cmpLiqD', cLiq - calcLiq]]
    .forEach(([id, diff])=>{
      const el = $(id);
      el.classList.toggle('cmp-ok', Math.abs(diff) < 0.01);
      el.classList.toggle('cmp-diff', Math.abs(diff) >= 0.01);
    });
}

// ====== PDF PARSE (via pdf.js CDN) ======
async function readPdfText(file){
  if(!window['pdfjsLib']) throw new Error('pdf.js não carregado');
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:new Uint8Array(buf)}).promise;
  let full = '';
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const strings = content.items.map(i=>i.str);
    full += '\\n' + strings.join(' ');
  }
  return full;
}

$('#fileTRCT').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const text = await readPdfText(f);
    autoFillTRCT(text);
    comparar();
  }catch(err){ alert('Erro ao ler PDF: '+err.message); }
});

function matchVal(regex, text){
  const m = regex.exec(text);
  if(!m) return null;
  const raw = (m[1] || m[2] || '').replace(/\\s/g,'');
  const num = raw.match(/(\\d{1,3}(\\.\\d{3})*|\\d+)(,\\d{2})?/g);
  if(!num) return null;
  const pick = num[num.length-1];
  return pick;
}
function setVal(id, v){ if(v!==null){ $(id).value = v; } }

function autoFillTRCT(text){
  const T = text.replace(/\\s{2,}/g,' ').toUpperCase();

  setVal('#trct_saldo',   matchVal(/SALDO\\s*DE\\s*SAL[ÁA]RIO.*?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_adic',    matchVal(/(INSALUBRIDADE|ADICIONAIS?|DSR).{0,40}?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_13',      matchVal(/13[ºO]\\s*(SAL[ÁA]RIO|PROPORCIONAL).{0,40}?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_ferias',  matchVal(/F[ÉE]RIAS\\s*(PROPORCIONAIS?).{0,40}?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_terco',   matchVal(/1\\/3\\s*(CONSTITUCIONAL|F[ÉE]RIAS).{0,40}?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_outras',  matchVal(/OUTRAS\\s*(VERBAS|PARCELAS).{0,40}?((\\d[\\d\\.\\,]*))/i, T));

  setVal('#trct_inss',    matchVal(/INSS(\\s*TOTAL)?\\.?{0,20}?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_ir',      matchVal(/IRRF?.{0,20}?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_faltas',  matchVal(/FALTAS?.{0,40}?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_480',     matchVal(/ART\\.?\\s*480.{0,40}?((\\d[\\d\\.\\,]*))/i, T));
  setVal('#trct_outdesc', matchVal(/(CONTRIBUI[ÇC][ÕO]ES?|OUTROS\\s*DESCONTOS?).{0,40}?((\\d[\\d\\.\\,]*))/i, T));
}

// Payslips batch
$('#filePayslips').addEventListener('change', async (e)=>{
  const files = [...(e.target.files||[])];
  if(files.length===0) return;
  const tbody = $('#histTable tbody'); tbody.innerHTML='';
  let somaVar = 0, nVar = 0;

  for(const f of files){
    try{
      const text = await readPdfText(f);
      const row = parsePayslip(text);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${f.name}</td>
        <td>${row.mes||'—'}</td>
        <td>${row.salBase?brl(row.salBase):'—'}</td>
        <td>${row.variaveis?brl(row.variaveis):'—'}</td>
        <td>${row.insal?brl(row.insal):'—'}</td>
        <td>${row.inss?brl(row.inss):'—'}</td>
        <td>${row.ir?brl(row.ir):'—'}</td>`;
      tbody.appendChild(tr);

      if(row.variaveis>0){ somaVar += row.variaveis; nVar++; }
    }catch(err){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${f.name}</td><td colspan="6">Erro ao ler PDF: ${err.message}</td>`;
      tbody.appendChild(tr);
    }
  }
  const media = nVar>0 ? somaVar/nVar : 0;
  $('#mediaVars').textContent = brl(media);
  if(media>0){ $('#mediaVar').value = media.toFixed(2).replace('.',','); calc(); }
});

function parsePayslip(text){
  const T = text.replace(/\\s{2,}/g,' ').toUpperCase();
  const pickNum = r => {
    const m = r.exec(T);
    if(!m) return 0;
    const raw = (m[1]||m[2]||'').replace(/\\s/g,'');
    const num = raw.match(/(\\d{1,3}(\\.\\d{3})*|\\d+)(,\\d{2})?/g);
    if(!num) return 0;
    const p = num[num.length-1];
    return parseBRL(p);
  };
  const mes = (T.match(/(COMPET[ÊE]NCIA|M[EÊ]S)\\s*[:\\-]?\\s*([A-Z]{3,9}\\/\\d{4})/) || [,'', ''])[2];

  const salBase = pickNum(/SAL[ÁA]RIO\\s*BASE.{0,40}?((\\d[\\d\\.\\,]*))/i);
  const he      = pickNum(/HORAS?\\s*EXTRAS?.{0,40}?((\\d[\\d\\.\\,]*))/i);
  const insal   = pickNum(/INSALUBRIDADE.{0,40}?((\\d[\\d\\.\\,]*))/i);
  const variaveis = he + insal;
  const inss    = pickNum(/INSS.{0,20}?((\\d[\\d\\.\\,]*))/i);
  const ir      = pickNum(/IRRF?.{0,20}?((\\d[\\d\\.\\,]*))/i);

  return {mes, salBase, variaveis, insal, inss, ir};
}

// init
calc(); comparar();
</script>
</body>
</html>
